/* infuse.js - v0.6.3 - 2013-05-10 - https://github.com/soundstep/infuse.js - http://www.soundstep.com */(function(t,r){"use strict";t.version="0.6.3";var n=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,e=/,/,i=/^\s*(_?)(\S+?)\1\s*$/,a=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;Array.prototype.contains||(Array.prototype.contains=function(t){for(var r=this.length;r--;)if(this[r]===t)return!0;return!1}),t.InjectorError={MAPPING_BAD_PROP:"[Error infuse.Injector.mapClass/mapValue] the first parameter is invalid, a string is expected",MAPPING_BAD_VALUE:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, it can't null or undefined, with property: ",MAPPING_BAD_CLASS:"[Error infuse.Injector.mapClass/mapValue] the second parameter is invalid, a function is expected, with property: ",MAPPING_BAD_SINGLETON:"[Error infuse.Injector.mapClass] the third parameter is invalid, a boolean is expected, with property: ",MAPPING_ALREADY_EXISTS:"[Error infuse.Injector.mapClass/mapValue] this mapping already exists, with property: ",CREATE_INSTANCE_INVALID_PARAM:"[Error infuse.Injector.createInstance] invalid parameter, a function is expected",NO_MAPPING_FOUND:"[Error infuse.Injector.getInstance] no mapping found",INJECT_INSTANCE_IN_ITSELF_PROPERTY:"[Error infuse.Injector.getInjectedValue] A matching property has been found in the target, you can't inject an instance in itself",INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR:"[Error infuse.Injector.getInjectedValue] A matching constructor parameter has been found in the target, you can't inject an instance in itself"};var o=function(t,r,n,e){this.prop=t,this.value=r,this.cl=n,this.singleton=e||!1},s=function(r){if("string"!=typeof r)throw Error(t.InjectorError.MAPPING_BAD_PROP)},p=function(n,e){if(e===r||null===e)throw Error(t.InjectorError.MAPPING_BAD_VALUE+n)},u=function(r,n){if("function"!=typeof n)throw Error(t.InjectorError.MAPPING_BAD_CLASS+r)},c=function(r,n){if("boolean"!=typeof n)throw Error(t.InjectorError.MAPPING_BAD_SINGLETON+r)},l=function(r,n){var e=t.getConstructorParams(n);if(e.contains(r))throw Error(t.InjectorError.INJECT_INSTANCE_IN_ITSELF_CONSTRUCTOR)},h=function(r,n){if(n.hasOwnProperty(r))throw Error(t.InjectorError.INJECT_INSTANCE_IN_ITSELF_PROPERTY)};t.Injector=function(){this.mappings={},this.parent=null},t.getConstructorParams=function(t){for(var r=[],o=(""+t).replace(a,""),s=o.match(n),p=s[1].split(e),u=0;p.length>u;u++){var c=p[u];c.replace(i,function(t,n,e){r.push(e)})}return r},t.Injector.prototype={createChild:function(){var r=new t.Injector;return r.parent=this,r},getMappingVo:function(t){return this.mappings?this.mappings[t]?this.mappings[t]:this.parent?this.parent.getMappingVo(t):null:null},mapValue:function(r,n){if(this.mappings[r])throw Error(t.InjectorError.MAPPING_ALREADY_EXISTS+r);return s(r),p(r,n),this.mappings[r]=new o(r,n),this},mapClass:function(r,n,e){if(this.mappings[r])throw Error(t.InjectorError.MAPPING_ALREADY_EXISTS+r);return s(r),u(r,n),e&&c(r,e),this.mappings[r]=new o(r,null,n,e),this},removeMapping:function(t){return this.mappings[t]=null,delete this.mappings[t],this},hasMapping:function(t){return!!this.mappings[t]},hasInheritedMapping:function(t){return!!this.getMappingVo(t)},getMapping:function(t){for(var r in this.mappings){var n=this.mappings[r];if(n.value===t||n.cl===t)return n.prop}},getValue:function(r){var n=this.mappings[r];if(!n){if(this.parent)return this.parent.getValue.apply(this.parent,arguments);throw Error(t.InjectorError.NO_MAPPING_FOUND)}return n.cl?(arguments[0]=n.cl,this.getValueFromClass.apply(this,arguments)):n.value},getClass:function(t){var n=this.mappings[t];return n?n.cl?n.cl:r:this.parent?this.parent.getClass(t):r},instantiate:function(n){if("function"!=typeof n)throw Error(t.InjectorError.CREATE_INSTANCE_INVALID_PARAM);for(var n=arguments[0],e=[null],i=t.getConstructorParams(n,this.mappings),a=0;i.length>a;a++)if(arguments[a+1]!==r&&null!==arguments[a+1])e.push(arguments[a+1]);else{var o=i[a],s=this.getMappingVo(o);if(s){var p=this.getInjectedValue(s,o);e.push(p)}else e.push(r)}return new(Function.prototype.bind.apply(n,e))},inject:function(t,r){this.parent&&this.parent.inject(t,!0);for(var n in this.mappings){var e=this.getMappingVo(n);if(t.hasOwnProperty(e.prop)){var i=this.getInjectedValue(e,n);t[n]=i}}return"function"!=typeof t.postConstruct||r||t.postConstruct(),this},getInjectedValue:function(r,n){var e,i=r.value;return r.cl&&(t.getConstructorParams(r.cl),r.singleton?(r.value||(l(n,r.cl),r.value=this.instantiate(r.cl),e=r.value),i=r.value):(l(n,r.cl),i=this.instantiate(r.cl),e=i)),e&&(h(n,e),this.inject(e)),i},createInstance:function(){var t=this.instantiate.apply(this,arguments);return this.inject(t),t},getValueFromClass:function(r){for(var n in this.mappings){var e=this.mappings[n];if(e.cl==r)return e.singleton?(e.value||(e.value=this.createInstance.apply(this,arguments)),e.value):this.createInstance.apply(this,arguments)}if(this.parent)return this.parent.getValueFromClass.apply(this.parent,arguments);throw Error(t.InjectorError.NO_MAPPING_FOUND)},dispose:function(){this.mappings={}}},Function.prototype.bind||(Function.prototype.bind=function(t){var r=this;if("function"!=typeof r)throw Error("Error, you must bind a function.");var n=Array.prototype.slice.call(arguments,1),e=function(){if(this instanceof e){var i=function(){};i.prototype=r.prototype;var a=new i,o=r.apply(a,n.concat(Array.prototype.slice.call(arguments)));return Object(o)===o?o:a}return r.apply(t,n.concat(Array.prototype.slice.call(arguments)))};return e}),"function"==typeof define&&define.amd&&define("infuse",t),"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports=t)})(this.infuse=this.infuse||{});